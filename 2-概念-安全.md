## 架构

Istio 中的安全性组件：

- 证书颁发机构（Certificate authority）：用于密钥和证书管理
- 配置 API 服务器分发给代理：
  - 认证策略（Authentication policies）
  - 授权策略（Authorization policies）
  - 安全命名信息（secure naming information）
- PEPs（Policy Enforcement Points）：策略实施点，通过Sidecar 和边缘代理作，保护客户端和服务器之间的通信安全
- 一组 Envoy 代理扩展：用于管理遥测和审计

<div>
    <image src="./img/arch-sec.svg"></image>
</div>

## Istio 身份

Istio 身份模型使用 `service identity` （服务身份）来确定一个请求源端的身份。可以用服务身份来标识人类用户、单个工作负载或一组工作负载。在没有服务身份的平台上，Istio 可以使用其它可以对服务实例进行分组的身份，例如服务名称。

## 公钥基础设施 (PKI)

Istio PKI (Public Key Infrastructure) 使用 X.509 证书为每个工作负载都提供强大的身份标识。伴随着每个 Envoy 代理的 `istio-agent` 和 `istiod` 一起协作来大规模进行自动化密钥和证书轮换

Istio 供应身份是通过 secret discovery service（SDS）来实现的，具体流程如下：

1. `istiod` 提供 gRPC 服务以接受[证书签名请求](https://en.wikipedia.org/wiki/Certificate_signing_request)（CSRs）。
2. 当工作负载启动时，Envoy 通过[秘密发现服务（SDS）](https://www.envoyproxy.io/docs/envoy/latest/configuration/security/secret#secret-discovery-service-sds)API 向同容器内的 `istio-agent` 发送证书和密钥请求。
3. 在收到 SDS 请求后，`istio-agent` 创建私钥和 CSR，然后将 CSR 及其凭据发送到 `istiod` CA 进行签名。
4. `istiod` CA 验证 CSR 中携带的凭据，成功验证后签署 CSR 以生成证书。
5. `Istio-agent` 通过 Envoy SDS API 将私钥和从 Istio CA 收到的证书发送给 Envoy。
6. `Istio-agent` 会监工作负载证书的有效期。上述 CSR 过程会周期性地重复，以处理证书和密钥轮换。

## 认证

Istio 提供两种类型的认证：

- Peer authentication：用于服务到服务的认证，以验证进行连接的客户端。Istio 提供 mTLS 作为传输认证的解决方案
- Request authentication：用于最终用户认证，以验证附加到请求的凭据。 Istio 使用 JSON Web Token（JWT）验证启用请求级认证

在所有情况下，Istio 都通过自定义 Kubernetes API 将认证策略存储在 `Istio config store`。Istiod 使每个代理保持最新状态，并在适当时提供密钥。

### 双向TLS 认证

Istio 通过客户端和服务器端 PEPs 建立服务到服务的通信通道，PEPs 被实现为[Envoy 代理](https://www.envoyproxy.io/)。当一个工作负载使用双向 TLS 认证向另一个工作负载发送请求时，该请求的处理方式如下：

1. Istio 将出站流量从客户端重新路由到客户端的本地 sidecar Envoy。
2. 客户端 Envoy 与服务器端 Envoy 开始双向 TLS 握手。在握手期间，客户端 Envoy 还做了[安全命名](https://istio.io/latest/zh/docs/concepts/security/#secure-naming)检查，以验证服务器证书中显示的服务帐户是否被授权运行目标服务。
3. 客户端 Envoy 和服务器端 Envoy 建立了一个双向的 TLS 连接，Istio 将流量从客户端 Envoy 转发到服务器端 Envoy。
4. 授权后，服务器端 Envoy 通过本地 TCP 连接将流量转发到服务器服务。